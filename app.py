# app.py
from pathlib import Path
from datetime import datetime, date, timedelta
from typing import Dict, List, Tuple

import pandas as pd
import streamlit as st

# =========================
# ê¸°ë³¸ ì„¤ì •
# =========================
st.set_page_config(page_title="Pilates Manager", page_icon="ğŸ‹ï¸", layout="wide")

DATA_DIR = Path(".")
MEMBERS_CSV   = DATA_DIR / "members.csv"
SESSIONS_CSV  = DATA_DIR / "sessions.csv"
EXER_DB_JSON  = DATA_DIR / "exercise_db.json"

# ğŸ’ PIN (Streamlit Cloudì˜ Secretsì— CHERRY_PWê°€ ìˆìœ¼ë©´ ê·¸ ê°’ì„ ìš°ì„  ì‚¬ìš©)
CHERRY_PIN = st.secrets.get("CHERRY_PW", "2974")

# ë‚´ë¶€ ì €ì¥ ê°’(í•œê¸€)ì€ ê·¸ëŒ€ë¡œ ìœ ì§€, í™”ë©´ í‘œì‹œëŠ” F/R/V ë¡œ
SITES = ["í”Œë¡œìš°", "ë¦¬ìœ ", "ë°©ë¬¸"]
SITE_COLOR = {"í”Œë¡œìš°": "#d9f0ff", "ë¦¬ìœ ": "#eeeeee", "ë°©ë¬¸": "#e9fbe9"}  # ì¹© ë°°ê²½ìƒ‰
SITE_MAP = {"í”Œë¡œìš°": "F", "ë¦¬ìœ ": "R", "ë°©ë¬¸": "V"}  # ì €ì¥ê°’ -> í‘œì‹œë¼ë²¨
REV_SITE_MAP = {v: k for k, v in SITE_MAP.items()}   # í‘œì‹œë¼ë²¨ -> ì €ì¥ê°’
SITE_LABELS = ["F", "R", "V"]  # selectbox í‘œì‹œ ìˆœì„œ

def site_to_label(site: str) -> str:
    return SITE_MAP.get(site, site)

def label_to_site(label: str) -> str:
    return REV_SITE_MAP.get(label, label)

# ë ˆë²¨/ê¸°êµ¬/ë™ì‘ ì´ˆê¸° DB (ì—†ìœ¼ë©´ ìë™ ìƒì„±/ì €ì¥, ì´í›„ ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ë™ì‘ì€ ëˆ„ì )
EX_DB_DEFAULT: Dict[str, List[str]] = {
    "Mat(Basic)": [
        "Roll down","The hundred","Roll up","Single leg circles",
        "Rolling like a ball","Single leg stretch","Double leg stretch",
        "Spine stretch forward"
    ],
    "Mat(Intermediate/Advanced)":[
        "Criss cross","Open leg rocker","Saw","Neck pull","Side kick series",
        "Teaser","Swimming","Scissors","Bicycle","Jack knife","Seal"
    ],
    "Reformer": [
        "Footwork series","Toes","Arches","Heels","Tendon stretch","The hundred",
        "Leg circles","Short box series","Elephant","Knee stretch series","Running",
        "Pelvic lift","Long box - pulling straps","Backstroke","Long stretch series",
        "Side split","Front split","Coordination"
    ],
    "Cadillac": [
        "Roll back","Leg spring series","Tower","Monkey","Teaser (push-through)",
        "Arm series","Push-through bar","Breathing"
    ],
    "Wunda chair": [
        "Footwork series","Push down","Pull up","Spine stretch forward","Teaser",
        "Mountain climb","Tabletop","Front balance control"
    ],
    "Spine corrector/Barrel":[
        "Swan","Horseback","Side sit up","Ballet stretch side","Thigh stretch"
    ],
    "Electric chair": ["Pumping series","Going up front","Press up bottom","Press up front"],
    "Pedi-pull": ["Chest expansion","Arm circles","Knee bends","Centering"],
    "ê¸°íƒ€": []
}

# =========================
# íŒŒì¼ ìœ í‹¸
# =========================
def ensure_files():
    DATA_DIR.mkdir(exist_ok=True)
    if not MEMBERS_CSV.exists():
        pd.DataFrame(columns=[
            "id","ì´ë¦„","ì—°ë½ì²˜","ì§€ì ","ë“±ë¡ì¼",
            "ì´ë“±ë¡","ë‚¨ì€íšŸìˆ˜","ë©”ëª¨",
            "ë°©ë¬¸ ì‹¤ìˆ˜ë ¹(ì›)","ìµœê·¼ ì¬ë“±ë¡ì¼","ì¬ë“±ë¡ ëˆ„ì "
        ]).to_csv(MEMBERS_CSV, index=False, encoding="utf-8-sig")
    if not SESSIONS_CSV.exists():
        pd.DataFrame(columns=[
            "id","ë‚ ì§œ","ì§€ì ","êµ¬ë¶„","ì´ë¦„","ì¸ì›","ë ˆë²¨","ê¸°êµ¬",
            "ë™ì‘(ë¦¬ìŠ¤íŠ¸)","ì¶”ê°€ë™ì‘","íŠ¹ì´ì‚¬í•­","ìˆ™ì œ","ë©”ëª¨",
            "ì·¨ì†Œ","ì‚¬ìœ ","ë¶„","í˜ì´(ì´)","í˜ì´(ì‹¤ìˆ˜ë ¹)"
        ]).to_csv(SESSIONS_CSV, index=False, encoding="utf-8-sig")
    if not EXER_DB_JSON.exists():
        pd.Series(EX_DB_DEFAULT).to_json(EXER_DB_JSON, force_ascii=False)

ensure_files()

def load_members() -> pd.DataFrame:
    return pd.read_csv(MEMBERS_CSV, dtype=str, encoding="utf-8-sig").fillna("")

def save_members(df: pd.DataFrame):
    df.to_csv(MEMBERS_CSV, index=False, encoding="utf-8-sig")

def load_sessions() -> pd.DataFrame:
    df = pd.read_csv(SESSIONS_CSV, dtype=str, encoding="utf-8-sig").fillna("")
    if not df.empty:
        df["ë‚ ì§œ"] = pd.to_datetime(df["ë‚ ì§œ"], errors="coerce")
        for c in ["ì¸ì›","ë¶„","í˜ì´(ì´)","í˜ì´(ì‹¤ìˆ˜ë ¹)"]:
            if c in df.columns:
                df[c] = pd.to_numeric(df[c], errors="coerce")
        df["ì·¨ì†Œ"] = df["ì·¨ì†Œ"].astype(str).str.lower().isin(["true","1","y","yes"])
    return df

def save_sessions(df: pd.DataFrame):
    df = df.copy()
    if not df.empty:
        df["ë‚ ì§œ"] = pd.to_datetime(df["ë‚ ì§œ"]).dt.strftime("%Y-%m-%d %H:%M:%S")
    df.to_csv(SESSIONS_CSV, index=False, encoding="utf-8-sig")

def load_ex_db() -> Dict[str, List[str]]:
    try:
        ser = pd.read_json(EXER_DB_JSON, typ="series")
        d = {k: list(v) for k, v in ser.items()}
        for k, v in EX_DB_DEFAULT.items():
            d.setdefault(k, v)
        return d
    except Exception:
        pd.Series(EX_DB_DEFAULT).to_json(EXER_DB_JSON, force_ascii=False)
        return EX_DB_DEFAULT

def save_ex_db(db: Dict[str, List[str]]):
    pd.Series(db).to_json(EXER_DB_JSON, force_ascii=False)

# =========================
# ê³µí†µ
# =========================
def big_info(msg: str, kind="info"):
    if kind == "warn": st.warning(msg)
    elif kind == "error": st.error(msg)
    else: st.info(msg)

def tag(text, bg):
    return f"<span style='background:{bg}; padding:2px 8px; border-radius:8px; font-size:12px;'>{text}</span>"

def calc_pay(site: str, session_type: str, headcount: int, visit_net: float|None) -> Tuple[float,float]:
    """
    returns (gross, net)
    í”Œë¡œìš°: íšŒë‹¹ 35,000ì›, 3.3% ê³µì œ
    ë¦¬ìœ : ê°œì¸ 30,000 / 3ëª… 40,000 / 2ëª… 30,000 / 1ëª… 25,000 / ë“€ì—£ 35,000 (ê³µì œ ì—†ìŒ)
    ë°©ë¬¸: ë©¤ë²„ ê¸°ë³¸ì„¤ì • 'ë°©ë¬¸ ì‹¤ìˆ˜ë ¹(ì›)' ì‚¬ìš© (gross=net)
    """
    gross = net = 0.0
    if site == "í”Œë¡œìš°":
        gross = 35000.0
        net = round(gross * 0.967, 0)
    elif site == "ë¦¬ìœ ":
        if session_type == "ê°œì¸":
            gross = net = 30000.0
        else:
            if headcount == 2:
                gross = net = 35000.0
            else:
                mapping = {3:40000.0, 2:30000.0, 1:25000.0}
                gross = net = mapping.get(headcount, 30000.0)
    else:  # ë°©ë¬¸
        gross = net = float(visit_net or 0)
    return gross, net

# =========================
# ë„¤ë¹„ê²Œì´ì…˜ (ì„¸ë¡œ ì‚¬ì´ë“œë°” / ì²« í˜ì´ì§€ = ìŠ¤ì¼€ì¤„)
# =========================
if "nav" not in st.session_state:
    st.session_state["nav"] = "ğŸ“… ìŠ¤ì¼€ì¤„"

nav_options = ["ğŸ“… ìŠ¤ì¼€ì¤„","ğŸ“ ì„¸ì…˜","ğŸ‘¥ ë©¤ë²„","ğŸ“‹ ë¦¬í¬íŠ¸","ğŸ’"]  # ğŸ’ë§Œ ì´ëª¨ì§€
nav = st.sidebar.radio(" ", options=nav_options,
                       index=nav_options.index(st.session_state["nav"]),
                       horizontal=False, key="nav_radio")
st.session_state["nav"] = nav
st.sidebar.markdown("&nbsp;", unsafe_allow_html=True)

# ë°ì´í„° ë¡œë“œ
members = load_members()
sessions = load_sessions()
ex_db = load_ex_db()

# =========================================================
# ğŸ‘¥ ë©¤ë²„
# =========================================================
if nav.startswith("ğŸ‘¥"):
    st.header("ë©¤ë²„ ê´€ë¦¬")

    with st.expander("â• ë“±ë¡/ìˆ˜ì •/ì¬ë“±ë¡", expanded=True):
        left, right = st.columns([1,1])

        existing = ["(ìƒˆ íšŒì›)"] + (members["ì´ë¦„"].tolist() if not members.empty else [])
        sel = st.selectbox("íšŒì› ì„ íƒ", existing, key="mem_select")

        sel_row = members[members["ì´ë¦„"]==sel].iloc[0] if (sel != "(ìƒˆ íšŒì›)" and not members.empty and sel in members["ì´ë¦„"].values) else None

        with left:
            name  = st.text_input("ì´ë¦„", "" if sel == "(ìƒˆ íšŒì›)" else sel, key="mem_name")
            phone = st.text_input(
                "ì—°ë½ì²˜",
                "" if sel_row is None else sel_row.get("ì—°ë½ì²˜",""),
                placeholder="010-0000-0000",
                key="mem_phone"
            )
            # ì „í™”ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬
            duplicated = False
            if phone.strip():
                dup = members[(members["ì—°ë½ì²˜"]==phone) & (members["ì´ë¦„"]!=name)]
                if not dup.empty:
                    st.error("âš ï¸ ì´ë¯¸ ë“±ë¡ëœ ì—°ë½ì²˜ì…ë‹ˆë‹¤. í™•ì¸í•´ì£¼ì„¸ìš”.")
                    duplicated = True

            # ê¸°ë³¸ ì§€ì (F/R/V í‘œì‹œ)
            site_default = "í”Œë¡œìš°" if sel_row is None else (sel_row.get("ì§€ì ") or "í”Œë¡œìš°")
            site_label_default = site_to_label(site_default)
            site_label = st.selectbox("ê¸°ë³¸ ì§€ì ", options=SITE_LABELS,
                                      index=SITE_LABELS.index(site_label_default),
                                      key="mem_site_label")
            site = label_to_site(site_label)  # ì €ì¥ì€ í•œê¸€

            visit_net_default = 0 if sel_row is None else int(float(sel_row.get("ë°©ë¬¸ ì‹¤ìˆ˜ë ¹(ì›)") or 0))
            visit_net = st.number_input("ë°©ë¬¸ ì‹¤ìˆ˜ë ¹(ì›)", 0, 1_000_000, visit_net_default, 1000, key="mem_visitnet")

        with right:
            reg_default = date.today() if sel_row is None else (
                pd.to_datetime(sel_row.get("ë“±ë¡ì¼"), errors="coerce").date() if sel_row.get("ë“±ë¡ì¼") else date.today()
            )
            reg_date = st.date_input("ë“±ë¡ì¼", reg_default, key="mem_regdate")

            add_cnt = st.number_input("ì¬ë“±ë¡ ì¶”ê°€ íšŸìˆ˜(+)", 0, 100, 0, 1, key="mem_addcnt")
            note = st.text_input("ë©”ëª¨(ì„ íƒ)", "" if sel_row is None else sel_row.get("ë©”ëª¨",""), key="mem_note")

        c1, c2, c3 = st.columns(3)
        with c1:
            disabled = duplicated or not name.strip()
            if st.button("ì €ì¥/ìˆ˜ì •", use_container_width=True, key="mem_save", disabled=disabled):
                if sel == "(ìƒˆ íšŒì›)":
                    new_id = str(len(members)+1)
                    row = pd.DataFrame([{
                        "id":new_id,"ì´ë¦„":name.strip(),"ì—°ë½ì²˜":phone.strip(),
                        "ì§€ì ":site,"ë“±ë¡ì¼":reg_date.isoformat(),
                        "ì´ë“±ë¡":"0","ë‚¨ì€íšŸìˆ˜":"0","ë©”ëª¨":note,
                        "ë°©ë¬¸ ì‹¤ìˆ˜ë ¹(ì›)": str(visit_net),
                        "ìµœê·¼ ì¬ë“±ë¡ì¼":"", "ì¬ë“±ë¡ ëˆ„ì ":"0"
                    }])
                    members_new = pd.concat([members, row], ignore_index=True)
                    save_members(members_new)
                    st.success(f"ì‹ ê·œ ë“±ë¡: {name}")
                else:
                    idx = members.index[members["ì´ë¦„"]==sel][0]
                    members.loc[idx,"ì´ë¦„"] = name.strip()
                    members.loc[idx,"ì—°ë½ì²˜"] = phone.strip()
                    members.loc[idx,"ì§€ì "] = site
                    members.loc[idx,"ë“±ë¡ì¼"] = reg_date.isoformat()
                    members.loc[idx,"ë©”ëª¨"] = note
                    members.loc[idx,"ë°©ë¬¸ ì‹¤ìˆ˜ë ¹(ì›)"] = str(visit_net)
                    save_members(members)
                    st.success("ìˆ˜ì • ì™„ë£Œ")

        with c2:
            if st.button("ì¬ë“±ë¡ ë°˜ì˜(+ë‚¨ì€íšŸìˆ˜, ì´ë“±ë¡)", use_container_width=True, key="mem_reenroll", disabled=(sel=="(ìƒˆ íšŒì›)" or add_cnt<=0)):
                idx = members.index[members["ì´ë¦„"]==sel][0]
                total = int(float(members.loc[idx,"ì´ë“±ë¡"] or 0)) + int(add_cnt)
                remain = int(float(members.loc[idx,"ë‚¨ì€íšŸìˆ˜"] or 0)) + int(add_cnt)
                members.loc[idx,"ì´ë“±ë¡"] = str(total)
                members.loc[idx,"ë‚¨ì€íšŸìˆ˜"] = str(remain)
                members.loc[idx,"ìµœê·¼ ì¬ë“±ë¡ì¼"] = date.today().isoformat()
                members.loc[idx,"ì¬ë“±ë¡ ëˆ„ì "] = str(int(float(members.loc[idx,"ì¬ë“±ë¡ ëˆ„ì "] or 0)) + int(add_cnt))
                save_members(members)
                st.success(f"{sel} ì¬ë“±ë¡ +{add_cnt}íšŒ ë°˜ì˜")

        with c3:
            del_name = st.selectbox("ì‚­ì œ ëŒ€ìƒ", members["ì´ë¦„"].tolist() if not members.empty else [], key="mem_del_sel")
            if st.button("ë©¤ë²„ ì‚­ì œ", use_container_width=True, key="mem_delete", disabled=members.empty):
                members2 = members[members["ì´ë¦„"]!=del_name].reset_index(drop=True)
                save_members(members2)
                st.success(f"{del_name} ì‚­ì œ ì™„ë£Œ")

    with st.expander("ğŸ“‹ ë©¤ë²„ ëª©ë¡ (ë“±ë¡ì¼/ì¬ë“±ë¡ ì •ë³´ í¬í•¨)", expanded=False):
        if members.empty:
            big_info("ë“±ë¡ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            show = members.copy()
            show["í‘œì‹œì§€ì "] = show["ì§€ì "].apply(site_to_label)
            show["ë“±ë¡ì¼"] = pd.to_datetime(show["ë“±ë¡ì¼"], errors="coerce").dt.date.astype(str)
            st.dataframe(show.drop(columns=["ì§€ì "]), use_container_width=True, hide_index=True)

    st.subheader("ğŸ“ˆ ì›”ê°„ Top5 ë™ì‘ & 6ê°œì›” ì¶”ì´")
    if sessions.empty:
        big_info("ì„¸ì…˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
    else:
        mnames = ["(ì„ íƒ)"] + sorted([x for x in sessions["ì´ë¦„"].dropna().unique() if x])
        selm = st.selectbox("ë©¤ë²„ ì„ íƒ", mnames, key="stats_member")
        if selm != "(ì„ íƒ)":
            now = date.today()
            month_mask = (
                (sessions["ì´ë¦„"]==selm) & (sessions["êµ¬ë¶„"]=="ê°œì¸") &
                (sessions["ë‚ ì§œ"].dt.year==now.year) & (sessions["ë‚ ì§œ"].dt.month==now.month)
            )
            dfm = sessions.loc[month_mask].copy()
            if dfm.empty:
                big_info("ì´ë²ˆ ë‹¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
            else:
                acts = []
                for s in dfm["ë™ì‘(ë¦¬ìŠ¤íŠ¸)"].fillna(""):
                    items = [x.strip() for x in s.split(";") if x.strip()]
                    acts.extend(items)
                if acts:
                    top = pd.Series(acts).value_counts().head(5).reset_index()
                    top.columns = ["ë™ì‘","íšŸìˆ˜"]
                    st.write("**ì´ë²ˆ ë‹¬ Top5 ë™ì‘**")
                    st.bar_chart(top.set_index("ë™ì‘"))

                    # 6ê°œì›” ì¶”ì´(Top5 ê¸°ì¤€)
                    target_moves = top["ë™ì‘"].tolist()
                    since = pd.Timestamp(now) - pd.DateOffset(months=5)
                    dfl = sessions[(sessions["ì´ë¦„"]==selm) & (sessions["êµ¬ë¶„"]=="ê°œì¸") & (sessions["ë‚ ì§œ"]>=since)].copy()
                    rows = []
                    for _, r in dfl.iterrows():
                        mm = [x.strip() for x in str(r["ë™ì‘(ë¦¬ìŠ¤íŠ¸)"]).split(";") if x.strip()]
                        for m in mm:
                            if m in target_moves:
                                rows.append({"YM": r["ë‚ ì§œ"].strftime("%Y-%m"), "ë™ì‘": m})
                    if rows:
                        agg = pd.DataFrame(rows).value_counts(["YM","ë™ì‘"]).rename("íšŸìˆ˜").reset_index()
                        pivot = agg.pivot(index="YM", columns="ë™ì‘", values="íšŸìˆ˜").fillna(0).sort_index()
                        st.write("**ìµœê·¼ 6ê°œì›” ì¶”ì´**")
                        st.line_chart(pivot)
                else:
                    big_info("ì´ë²ˆ ë‹¬ì— ê¸°ë¡ëœ ë™ì‘ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.")

# =========================================================
# ğŸ“ ì„¸ì…˜ (ê°œì¸/ê·¸ë£¹)
# =========================================================
elif nav.startswith("ğŸ“"):
    st.header("ì„¸ì…˜ ê¸°ë¡")

    if members.empty:
        big_info("ë¨¼ì € ë©¤ë²„ë¥¼ ë“±ë¡í•˜ì„¸ìš”.")
    else:
        # ê³µí†µ ìƒë‹¨
        c0, c1, c2, c3 = st.columns([1,1,1,1])
        with c0:
            day = st.date_input("ë‚ ì§œ", value=date.today(), key="ses_day")
            time_str = st.time_input("ì‹œê°„", value=datetime.now().time(), key="ses_time")
        with c1:
            session_type = st.radio("êµ¬ë¶„", ["ê°œì¸","ê·¸ë£¹"], horizontal=True, key="ses_type")
        with c2:
            site_label_sel = st.selectbox("ì§€ì (F/R/V)", SITE_LABELS, key="ses_site_label")
            site = label_to_site(site_label_sel)  # ì €ì¥ì€ í•œê¸€
        with c3:
            minutes = st.number_input("ìˆ˜ì—… ë¶„", 10, 180, 50, 5, key="ses_minutes")

        # ê³µí†µ ë ˆë²¨/ê¸°êµ¬
        cc1, cc2 = st.columns([1,1])
        with cc1:
            level = st.selectbox("ë ˆë²¨", ["Basic","Intermediate","Advanced","Mixed","NA"], key="ses_level")
        with cc2:
            equip = st.selectbox("ê¸°êµ¬", ["Reformer","Cadillac","Wunda chair","Spine corrector/Barrel","Mat","ê¸°íƒ€"], key="ses_equip")

        # ê°œì¸ / ê·¸ë£¹ ë¶„ê¸°
        mname = ""
        headcount = 1
        if session_type == "ê°œì¸":
            # ë©¤ë²„ ì„ íƒ ë° ì§€ì  ìë™ ì œì•ˆ(F/R/V)
            mname = st.selectbox("ë©¤ë²„", members["ì´ë¦„"].tolist(), key="ses_member")
            if mname:
                try:
                    auto_site = members.loc[members["ì´ë¦„"]==mname,"ì§€ì "].iloc[0] or "í”Œë¡œìš°"
                    auto_label = site_to_label(auto_site)
                    site_label_sel = st.selectbox("ì§€ì (ìë™ ì¶”ì²œ, F/R/V)", SITE_LABELS,
                                                  index=SITE_LABELS.index(auto_label), key="ses_site_auto_label")
                    site = label_to_site(site_label_sel)
                except Exception:
                    pass
        else:  # ê·¸ë£¹
            headcount = st.number_input("ì¸ì›(ê·¸ë£¹)", 1, 10, 2, 1, key="ses_group_headcount")

        # ê¸°êµ¬ë³„ ë™ì‘ í•„í„°
        equip_map = {
            "Mat": ["Mat(Basic)", "Mat(Intermediate/Advanced)"],
            "Reformer": ["Reformer"],
            "Cadillac": ["Cadillac"],
            "Wunda chair": ["Wunda chair"],
            "Spine corrector/Barrel": ["Spine corrector/Barrel", "Large barrel", "Small barrel / Spine corrector", "Spine corrector"],
            "ê¸°íƒ€": ["Electric chair","Pedi-pull","ê¸°íƒ€"]
        }
        cat_list = equip_map.get("Mat" if equip=="Mat" else equip, [])
        per_moves_list = []
        for cat in cat_list:
            if cat in ex_db:
                per_moves_list.extend(list(ex_db[cat]))
        per_moves_list = sorted({m for m in per_moves_list if isinstance(m, str) and m.strip()})

        # ì…ë ¥ UI (ìš”ì²­ëŒ€ë¡œ: ê·¸ë£¹ì€ ë™ì‘/ìˆ™ì œ ì…ë ¥ ì—†ìŒ)
        if session_type == "ê°œì¸":
            chosen = st.multiselect("ìš´ë™ ë™ì‘(ë³µìˆ˜)", options=per_moves_list, key="ses_moves_select")
            add_free = st.text_input("ì¶”ê°€ ë™ì‘(ì‰¼í‘œ , ë¡œ êµ¬ë¶„)", placeholder="ì˜ˆ: Side bends, Mermaid", key="ses_moves_free")
            col_note, col_hw = st.columns([1,1])
            with col_note:
                special_note = st.text_area("íŠ¹ì´ì‚¬í•­(ì„ íƒ)", height=80, key="ses_special_note")
            with col_hw:
                homework = st.text_area("ìˆ™ì œ(ì„ íƒ)", height=80, key="ses_homework")
        else:
            chosen = []
            add_free = ""
            special_note = st.text_area("íŠ¹ì´ì‚¬í•­(ì„ íƒ)", height=80, key="group_special_note")
            homework = ""

        cancel = st.checkbox("ì·¨ì†Œ", key="ses_cancel")
        reason = st.text_input("ì‚¬ìœ (ì„ íƒ)", placeholder="ì˜ˆ: íšŒì› ì‚¬ì •/ê°•ì‚¬ ì‚¬ì • ë“±", key="ses_reason")

        if st.button("ì„¸ì…˜ ì €ì¥", use_container_width=True, key="ses_save_btn"):
            when = datetime.combine(day, time_str)

            # ììœ  ì…ë ¥ ë™ì‘ 'ê¸°íƒ€'ì— ëˆ„ì 
            if add_free.strip():
                new_moves = [x.strip() for x in add_free.split(",") if x.strip()]
                updated = load_ex_db()
                updated.setdefault("ê¸°íƒ€", [])
                for nm in new_moves:
                    if nm not in updated["ê¸°íƒ€"]:
                        updated["ê¸°íƒ€"].append(nm)
                save_ex_db(updated)

            # ë°©ë¬¸(ê°œì¸) ì‹¤ìˆ˜ë ¹ì€ ë©¤ë²„ í”„ë¡œí•„ì—ì„œ
            custom_visit = None
            if session_type == "ê°œì¸" and site == "ë°©ë¬¸" and mname:
                if "ë°©ë¬¸ ì‹¤ìˆ˜ë ¹(ì›)" in members.columns:
                    try:
                        custom_visit = float(members.loc[members["ì´ë¦„"]==mname, "ë°©ë¬¸ ì‹¤ìˆ˜ë ¹(ì›)"].iloc[0] or 0)
                    except Exception:
                        custom_visit = None

            gross, net = calc_pay(site, session_type, int(headcount), custom_visit)

            row = {
                "id": str(len(sessions) + 1),
                "ë‚ ì§œ": when,
                "ì§€ì ": site,                         # ì €ì¥ì€ í•œê¸€
                "êµ¬ë¶„": session_type,
                "ì´ë¦„": mname if session_type == "ê°œì¸" else "",
                "ì¸ì›": int(headcount) if session_type == "ê·¸ë£¹" else 1,
                "ë ˆë²¨": level,
                "ê¸°êµ¬": equip,
                "ë™ì‘(ë¦¬ìŠ¤íŠ¸)": "; ".join(chosen),
                "ì¶”ê°€ë™ì‘": add_free,
                "íŠ¹ì´ì‚¬í•­": special_note,
                "ìˆ™ì œ": homework,
                "ë©”ëª¨": "",
                "ì·¨ì†Œ": bool(cancel),
                "ì‚¬ìœ ": reason,
                "ë¶„": int(minutes),
                "í˜ì´(ì´)": float(gross),
                "í˜ì´(ì‹¤ìˆ˜ë ¹)": float(net),
            }
            # ëˆ„ë½ ì»¬ëŸ¼ ëŒ€ë¹„
            for col in row.keys():
                if col not in sessions.columns:
                    sessions[col] = ""
            sessions = pd.concat([sessions, pd.DataFrame([row])], ignore_index=True)
            save_sessions(sessions)

            # ê°œì¸ ì •ìƒ ì§„í–‰ì´ë©´ ë‚¨ì€íšŸìˆ˜ ì°¨ê°
            if session_type == "ê°œì¸" and mname and not cancel and (mname in members["ì´ë¦„"].values):
                idx = members.index[members["ì´ë¦„"]==mname][0]
                try:
                    remain = max(0, int(float(members.loc[idx,"ë‚¨ì€íšŸìˆ˜"] or 0)) - 1)
                except Exception:
                    remain = 0
                members.loc[idx,"ë‚¨ì€íšŸìˆ˜"] = str(remain)
                save_members(members)

            st.success("ì„¸ì…˜ ì €ì¥ ì™„ë£Œ!")

        st.subheader("ìµœê·¼ ì„¸ì…˜ ëª©ë¡")
        if sessions.empty:
            big_info("ì„¸ì…˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            view = sessions.sort_values("ë‚ ì§œ", ascending=False).copy()
            hide_cols = ["í˜ì´(ì´)","í˜ì´(ì‹¤ìˆ˜ë ¹)"]
            view["í‘œì‹œì§€ì "] = view["ì§€ì "].apply(site_to_label)  # F/R/Vë¡œ
            view["ë‚ ì§œ"] = pd.to_datetime(view["ë‚ ì§œ"], errors="coerce").dt.strftime("%Y-%m-%d %H:%M")
            show_cols = [c for c in view.columns if c not in hide_cols and c != "ì§€ì "]
            # ë³´ê¸° ì¢‹ì€ ìœ„ì¹˜ì— í‘œì‹œì§€ì  ì‚½ì…
            if "í‘œì‹œì§€ì " not in show_cols:
                insert_pos = show_cols.index("êµ¬ë¶„")+1 if "êµ¬ë¶„" in show_cols else 1
                show_cols = show_cols[:insert_pos] + ["í‘œì‹œì§€ì "] + show_cols[insert_pos:]
            st.dataframe(view[show_cols], use_container_width=True, hide_index=True)

# =========================================================
# ğŸ“… ìŠ¤ì¼€ì¤„ (ì¼/ì£¼/ì›”) + ì§€ë‚œ ìˆ˜ì—… ìƒì„¸ + ì·¨ì†Œ í† ê¸€
# =========================================================
elif nav.startswith("ğŸ“…"):
    st.header("ìŠ¤ì¼€ì¤„ (ì¼/ì£¼/ì›”)")
    if sessions.empty:
        big_info("ì„¸ì…˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
    else:
        mode = st.segmented_control("ë³´ê¸°", options=["ì¼","ì£¼","ì›”"], default="ì£¼", key="cal_mode")
        base = st.date_input("ê¸°ì¤€ ë‚ ì§œ", value=date.today(), key="cal_base")
        base_dt = datetime.combine(base, datetime.min.time())

        if mode == "ì¼":
            start = base_dt
            end   = base_dt + timedelta(days=1)
        elif mode == "ì£¼":
            start = base_dt - timedelta(days=base_dt.weekday())
            end   = start + timedelta(days=7)
        else:
            start = base_dt.replace(day=1)
            end   = (start + pd.offsets.MonthEnd(1)).to_pydatetime() + timedelta(days=1)

        view = sessions[(sessions["ë‚ ì§œ"]>=start) & (sessions["ë‚ ì§œ"]<end)].copy()
        if view.empty:
            big_info("í•´ë‹¹ ê¸°ê°„ì— ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.")
        else:
            view = view.sort_values("ë‚ ì§œ")
            st.caption("ê³¼ê±° ì„¸ì…˜ì€ **ë™ì‘/íŠ¹ì´ì‚¬í•­/ìˆ™ì œ**ê°€ í•¨ê»˜ ë³´ì…ë‹ˆë‹¤. (ì·¨ì†Œ í† ê¸€ ê°€ëŠ¥)")

            with st.form("cancel_form"):
                rows_html = []
                updates = []

                for _, r in view.iterrows():
                    dt_txt = pd.to_datetime(r["ë‚ ì§œ"]).strftime("%m/%d %a %H:%M")
                    who = r["ì´ë¦„"] if r["ì´ë¦„"] else "(ê·¸ë£¹)"
                    site_label = site_to_label(r["ì§€ì "])
                    site_chip = tag(site_label, SITE_COLOR.get(r["ì§€ì "], "#eee"))

                    details = []
                    if pd.to_datetime(r["ë‚ ì§œ"]) < datetime.now():
                        if r.get("ë™ì‘(ë¦¬ìŠ¤íŠ¸)"): details.append(f'ë™ì‘: {r.get("ë™ì‘(ë¦¬ìŠ¤íŠ¸")}')
                        if r.get("ì¶”ê°€ë™ì‘"):     details.append(f'ì¶”ê°€: {r.get("ì¶”ê°€ë™ì‘")}')
                        if r.get("íŠ¹ì´ì‚¬í•­"):     details.append(f'íŠ¹ì´: {r.get("íŠ¹ì´ì‚¬í•­")}')
                        if r.get("ìˆ™ì œ"):         details.append(f'ìˆ™ì œ: {r.get("ìˆ™ì œ")}')

                    title_html = f"{dt_txt} Â· {site_chip} Â· <b>{who}</b> Â· {r['êµ¬ë¶„']} Â· {r['ë ˆë²¨']} Â· {r['ê¸°êµ¬']}"
                    if bool(r["ì·¨ì†Œ"]): title_html = f"<s>{title_html}</s>"

                    body_html = ""
                    if details:
                        body_html = "<div style='color:#bbb; margin-top:2px;'>" + " Â· ".join(details) + "</div>"

                    cb_key = f"cancel_{r['id']}"
                    val = st.checkbox(f"ì·¨ì†Œ â¬…ï¸  ({dt_txt} / {who})", value=bool(r["ì·¨ì†Œ"]), key=cb_key)
                    updates.append((r.name, val))

                    rows_html.append(
                        f"<div style='padding:10px 0; border-bottom:1px solid #333'>{title_html}{body_html}</div>"
                    )

                st.markdown("<div>" + "".join(rows_html) + "</div>", unsafe_allow_html=True)
                if st.form_submit_button("ë³€ê²½ ì €ì¥", use_container_width=True):
                    for idx, v in updates:
                        sessions.loc[idx,"ì·¨ì†Œ"] = bool(v)
                    save_sessions(sessions)
                    st.success("ì·¨ì†Œ ìƒíƒœê°€ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.")

# =========================================================
# ğŸ“‹ ë¦¬í¬íŠ¸ (ê°„ë‹¨ ë³´ë“œ)
# =========================================================
elif nav.startswith("ğŸ“‹"):
    st.header("ğŸ“‹ ë¦¬í¬íŠ¸")
    if sessions.empty:
        big_info("ì„¸ì…˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
    else:
        df = sessions.copy()
        df["YM"] = pd.to_datetime(df["ë‚ ì§œ"]).dt.strftime("%Y-%m")
        s1 = df.groupby("YM")["id"].count().rename("ì„¸ì…˜ìˆ˜")
        s2 = df.groupby("YM")["ë¶„"].sum().rename("ì´ë¶„")
        board = pd.concat([s1, s2], axis=1).reset_index()
        st.dataframe(board, use_container_width=True, hide_index=True)

# =========================================================
# ğŸ’ ìˆ˜ì… (PIN ì ê¸ˆ, í—¤ë”ëŠ” ì´ëª¨ì§€ë§Œ)
# =========================================================
elif nav == "ğŸ’":
    st.header("ğŸ’")
    if "cherry_ok" not in st.session_state or not st.session_state["cherry_ok"]:
        pin = st.text_input("PIN ì…ë ¥", type="password", placeholder="****", key="cherry_pin")
        if st.button("ì—´ê¸°", key="cherry_open"):
            if pin == CHERRY_PIN:
                st.session_state["cherry_ok"] = True
                st.experimental_rerun()
            else:
                st.error("PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    else:
        if sessions.empty:
            big_info("ì„¸ì…˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            df = sessions.copy()
            df["Y"]  = pd.to_datetime(df["ë‚ ì§œ"]).dt.year
            df["YM"] = pd.to_datetime(df["ë‚ ì§œ"]).dt.strftime("%Y-%m")
            month_sum = df.groupby("YM")["í˜ì´(ì‹¤ìˆ˜ë ¹)"].sum().astype(int).reset_index()
            year_sum  = df.groupby("Y")["í˜ì´(ì‹¤ìˆ˜ë ¹)"].sum().astype(int).reset_index()
            c1, c2 = st.columns(2)
            with c1:
                st.subheader("ì›”ë³„ í•©ê³„")
                st.dataframe(month_sum, use_container_width=True, hide_index=True)
            with c2:
                st.subheader("ì—°ë„ í•©ê³„")
                st.dataframe(year_sum, use_container_width=True, hide_index=True)

            st.subheader("ìƒì„¸(ê°œë³„ ì„¸ì…˜)")
            v = df.sort_values("ë‚ ì§œ", ascending=False)
            v["í‘œì‹œì§€ì "] = v["ì§€ì "].apply(site_to_label)
            v["ë‚ ì§œ"] = pd.to_datetime(v["ë‚ ì§œ"]).dt.strftime("%Y-%m-%d %H:%M")
            st.dataframe(v.drop(columns=["ì§€ì "]), use_container_width=True, hide_index=True)
